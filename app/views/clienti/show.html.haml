- title @cliente.titolo

= new_button( new_appunto_url(cliente: @cliente) )



.content
  %section.well.show-page{ class: "cliente #{dom_id(@cliente)}"}
    %header
    %article.row-fluid
      .location.span4
        - unless @cliente.latitude.nil?
          .map-avatar
            - @mappa = @cliente.to_gmaps4rails
            = gmaps({ :markers => {:data => @mappa }, :map_options => { :type => "ROADMAP", :zoom => 15, :auto_zoom => false } }, false, false)
      .content-inner.span8
        %h1= @cliente.titolo
        %address
          %strong
            = "@#{@cliente.ragione_sociale || [@cliente.nome, @cliente.cognome].join(' ')}"
          %br
          = @cliente.indirizzo
          %br
          = "#{@cliente.cap} #{@cliente.frazione} #{@cliente.comune} #{@cliente.provincia}"
        %div.pull-left
          Partita IVA:
          = @cliente.partita_iva
          %br
          Codice Fiscale:
          = @cliente.codice_fiscale
        %div.pull-right
          
          - unless @cliente.telefono.blank?
            %a.btn{ href: "tel:#{@cliente.telefono.split.join}" }
              %i.icon-phone
              = @cliente.telefono
            %br

          - unless @cliente.email.blank?
            %a.btn{ href: "mailto:#{@cliente.email}" }
              %i.icon-envelope
              = @cliente.email
            %br
          
          - unless @cliente.latitude.nil?
            %a.btn{ href: "http://maps.apple.com/maps?q=#{@cliente.latitude},#{@cliente.longitude}" }
              / %a.btn{ href: "navigon://coordinate/#{@cliente.titolo.parameterize}/#{@cliente.longitude}/#{@cliente.latitude}" }
              %i.icon-road
              Mostra percorso

    %footer.show-toolbar
      .btn-group.pull-left
        = previous_tag cliente_url(Cliente.previous(@cliente, 'id').first)
        = next_tag cliente_url(Cliente.next(@cliente, 'id').first)
      
      %ul.inline.pull-left{ style: "margin-top: 5px;"}
        - for v in @cliente.visite.order("start desc") do
          - if v.giorno
            %li{ style: "margin-right: 5px"}
              = link_to giro_path(giorno: v.giorno) do
                %span.label.label-important
                  = v.giorno.strftime("%d %B %Y")
      .pull-right
        = baule_tag @cliente, class_scarica: "btn btn-warning"
        - unless @cliente.has_documenti?
          = link_to @cliente, method: 'delete', title: 'elimina', confirm: "Sei sicuro?", class: "btn btn-danger" do
            %i.icon-trash
            Elimina
        = link_to edit_cliente_url(@cliente), class: "btn btn-primary" do
          %i.icon-pencil
          Modifica
        = link_to "Fattura",  new_fattura_url(causale: 1, cliente_id: @cliente.id), class: "btn btn-warning"

  - if @cliente.cliente_tipo == "Scuola Primaria"
    
    .row
      .foglio-scuola.module.span12
        
        .header
          = show_hide_tag  "down"
          
          %h2.pull-left Foglio Scuola
          
          .pull-right
            = form_tag print_multiple_adozioni_path, :method => :put, target: "_blank", :id => "form_print_adozioni" do
              - for a in @cliente.mie_adozioni do
                = hidden_field_tag "adozione_ids[]", a.id
              = submit_tag "Stampa Adozioni",  id: "bnt-pdf", class: "btn"
              / = select_tag "tipo_etichetta", options_for_select(["2x4 con bordo", "2x4 senza bordo", "3x8", "2x6", "Dymo 99012"])
              / = number_field_tag "etichetta_da", "", class: "input-mini", placeholder: "salta"



          - if @cliente.da_scorrere?
            = link_to "Scorri classi", scorri_classi_cliente_url(@cliente), class: "btn btn-danger pull-right", confirm: "Sei sicuro?"
          .clearfix
          
        

        .more.hidden.clearfix

          - coef = @cliente.max_classi
          
          - @cliente.classi_adozioni_grouped.each do |k, classi|
            
            .row-classi.clearfix
              
              .header-classi
                .inner
                  %h1= k
              
              - classi.each do |c|
                
                .classe{style: "width: #{90/coef}%;"}
                  
                  .inner

                    .dropdown.pull-right
                      = link_to "...",  "#", class: "btn btn-link dropdown-toggle", "data-toggle" => "dropdown" 

                      %ul.dropdown-menu{ role: "menu", "aria-labelledby" => "dLabel" }

                        %li= link_to 'nuovo appunto', new_appunto_path(cliente: c.cliente.id, destinatario: "#{c.classe}#{c.sezione} #{c.insegnanti}"), title: "nuovo appunto"
                        / %li.dropdown-submenu.pull-left
                          

                        /   %ul.dropdown-menu
                        /     %li
                        /       = form_for c, url: registra_documento_cliente_path(c), method: "put", html: {class: "form-inline"} do |f|
                        /         = hidden_field_tag 'data_documento', "ultima"
                        /         = hidden_field_tag 'causale_id', 0
                        /         - for a, righe in r.group_by(&:appunto) do
                        /           = hidden_field_tag "appunto_ids[]", a.id 
                        /         = f.submit "ultima data inserita", class: "btn btn-link"
                            
                        /     %li.divider
                            
                        /     %li
                        /       = form_for c, url: registra_documento_cliente_path(c), method: "put" do |f|
                        /         = hidden_field_tag 'causale_id', 0
                        /         - for a, righe in r.group_by(&:appunto) do
                        /           = hidden_field_tag "appunto_ids[]", a.id 
                        /         = f.submit "oggi", class: "btn btn-link"



                    .sezione
                      %h1
                        =c[:sezione]
                        %small
                          = on_the_spot_edit c, :nr_alunni, tooltip: "#"

                    .insegnanti
                      = on_the_spot_edit c, :insegnanti, tooltip: "..." 
                    .note
                      = on_the_spot_edit c, :note, tooltip: "...", type: :textarea

                
                    .clearfix  
                    
                    - unless c.adozioni.scolastico.empty?
                      %ul.inline
                        - for a in c.adozioni.scolastico do
                          %li[a]
                            - if a.kit_1 == 'consegnato'
                              %span.label.label-warning= "#{a.libro.sigla}"
                            - else
                              %span.label.label-important= "#{a.libro.sigla}"

                        - unless c.libro_1.blank? || c.libro_1 == 'vacanze_vuoto'
                          %li.vacanza= image_tag asset_path "#{c.libro_1}.png"
                        - unless c.libro_2.blank? || c.libro_2 == 'vacanze_vuoto'
                          %li.vacanza= image_tag asset_path "#{c.libro_2}.png"
                        - unless c.libro_3.blank? || c.libro_3 == 'vacanze_vuoto'
                          %li.vacanza= image_tag asset_path "#{c.libro_3}.png"


          / %table.table.table-bordered.classi-adozioni
          /   - @cliente.classi_adozioni_grouped.each do |k, classi|
          /     %tr
          /       %td.classe-group{style: "width: 10%;"}
          /         .badge.badge-primary.pull-left= k
          /       - classi.each do |c|
          /         %td[c]{style: "width: #{90/coef}%;"}
          /           .pull-left
          /             .badge.badge-info.sezione
          /               =c[:sezione]

          /           .insegnanti

          /             %strong= c.insegnanti
          /           .note
          /             = c.note

          /           .pull-right
          /             = link_to new_appunto_path(cliente: c.cliente.id, destinatario: "#{c.classe}#{c.sezione} #{c.insegnanti}"), class: "btn", tile: "nuovo appunto" do
          /               %i.icon-book
                
          /           .clearfix  
          /           - unless c.adozioni.scolastico.empty?
          /             %ul.adozioni-list
          /               - for a in c.adozioni.scolastico do
          /                 %li[a]
          /                   - if a.kit_1 == 'consegnato'
          /                     %span.label.label-warning= "#{a.libro.sigla}"
          /                   - else
          /                     %span.label.label-important= "#{a.libro.sigla}"

          /           - unless c.libro_1.blank? || c.libro_1 == 'vacanze_vuoto'
          /             = image_tag asset_path "#{c.libro_1}.png"
          /           - unless c.libro_2.blank? || c.libro_2 == 'vacanze_vuoto'
          /             = image_tag asset_path "#{c.libro_2}.png"
          /           - unless c.libro_3.blank? || c.libro_3 == 'vacanze_vuoto'
          /             = image_tag asset_path "#{c.libro_3}.png"


            
  .row
    .side-bar.span3
      
      .module
        .header
          = show_hide_tag
          %h3 Documenti
        .more.riepilogo-libri  
          %ul
            = render partial: "fatture/fattura_item", collection: @cliente.fatture.per_numero, as: :fattura

      - unless @cliente.new_record?  
        - da_consegnare  = @cliente.righe.joins(:libro).includes(:libro).di_questa_propaganda.da_consegnare.order("libri.titolo")
        = render partial: "shared/riepilogo_libri", locals: { tipo_riepilogo: "da_consegnare", collection: da_consegnare} unless da_consegnare.empty?

        - da_pagare = @cliente.righe.joins(:libro).includes(:libro).di_questa_propaganda.da_pagare.order("libri.titolo")
        = render partial: "shared/riepilogo_libri", locals: { tipo_riepilogo: "da_pagare", collection: da_pagare} unless da_pagare.empty?
        

      - if @cliente.scuola_primaria?
        = render "classi_adozioni"
        = render "classi_inserters/form"
      - else
        &nbsp
        
    .center.span5
      %header.content-header
        .header-inner
          %h2 Appunti
        
      - @appunti_per_anno = @cliente.appunti.recente.group_by { |t| t.created_at.year }
      .appunti
        - for anno, values in @appunti_per_anno do
          .item
            %h3= anno
          - for a in values do
            = render a, grouped: "grouped"
          
      .stream-loader
      
    .side-bar.span4
      - if @cliente.longitude && @cliente.latitude
        .module
          .header
            = show_hide_tag
            %h3 
              = "#{pluralize @cliente.nearbys(10).con_appunti(current_user.appunti.da_fare).size, 'cliente'}"
              %small vicini con appunti da fare
          .clienti.more
            = render @cliente.nearbys(10).con_appunti(current_user.appunti.da_fare)
        .module 
          .header
            = show_hide_tag
            %h3 
              = "#{pluralize @cliente.nearbys(10).con_appunti(current_user.appunti.in_sospeso).size, 'cliente'}"
              %small vicini con appunti in sospeso
            
          .clienti.more
            = render @cliente.nearbys(10).con_appunti(current_user.appunti.in_sospeso)
      